{% extends 'base.html.twig' %}

{% block title %}Éditer une œuvre{% endblock %}

{% block body %}
    <div class="max-w-6xl mx-auto py-10 px-4">
        <h1 class="text-3xl font-bold mb-6">Éditer une œuvre</h1>

        {{ form_start(form, {'attr': {'enctype': 'multipart/form-data', 'class': 'space-y-4'}}) }}

            <div>
                {{ form_label(form.title, null, {'label_attr': {'class': 'block font-medium'}}) }}
                {{ form_widget(form.title, {'attr': {'class': 'w-full p-2 bg-slate-800 mt-2 rounded-lg'}}) }}
            </div>

            <div>
                {{ form_label(form.description, null, {'label_attr': {'class': 'block font-medium'}}) }}
                {{ form_widget(form.description, {'attr': {'class': 'w-full p-2 bg-slate-800 mt-2 rounded-lg resize-none h-32'}}) }}
            </div>

            <div id="images-wrapper" 
                    class="space-y-4" 
                    data-prototype="{{ form_widget(form.images.vars.prototype)|e('html_attr') }}">
                {% for image in form.images %}
                    <div class="image-block p-4 rounded-lg">
                        <div>
                            {{ form_label(image.title, null, {'label_attr': {'class': 'block font-medium'}}) }}
                            {{ form_widget(image.title, {'attr': {'class': 'w-full p-2 bg-slate-800 mt-2 border rounded-lg'}}) }}
                        </div>

                        <div class="mt-2">
                            {{ form_label(image.file, null, {'label_attr': {'class': 'block font-medium'}}) }}
                            {{ form_widget(image.file, {'attr': {'class': 'w-full p-2 bg-slate-800 mt-2 border rounded-lg'}}) }}
                        </div>

                        {% if image.vars.data.link %}
                            <img src="{{ asset('/uploads/oeuvres/' ~ image.vars.data.link) }}" class="mt-3 w-32 h-32 object-cover rounded-lg shadow-md">
                        {% endif %}

                        {# Ajouter un champ caché pour marquer l'image comme supprimée #}
                        {{ form_widget(image.remove, {'attr': {'class': 'remove-checkbox hidden'}}) }}

                        <button type="button" class="remove-image mt-3 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            Supprimer
                        </button>
                    </div>
                {% endfor %}
            </div>

            <button type="button" id="add-image" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Ajouter une image
            </button>

            <button type="submit" class="mt-6 w-full bg-cyan-700 text-white px-4 py-2 rounded-lg hover:bg-cyan-800">
                Enregistrer
            </button>

        {{ form_end(form) }}
    </div>

    <script>
        document.addEventListener('turbo:load', function () {
            let collectionHolder = document.querySelector('#images-wrapper');
            let addImageButton = document.getElementById('add-image');
            let prototype = collectionHolder.dataset.prototype;
        
            if (!prototype) {
                console.error("Prototype non défini. Vérifiez que le formulaire contient bien un champ CollectionType.");
                return;
            }
        
            addImageButton.addEventListener('click', function () {
                let index = collectionHolder.querySelectorAll('.image-block').length;
                let newForm = prototype.replace(/__name__/g, index);
                let div = document.createElement('div');
                div.classList.add('image-block', 'p-4', 'bg-slate-700', 'mt-2', 'rounded-lg', 'shadow-sm');
                div.innerHTML = newForm;
        
                let removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.classList.add('remove-image', 'mt-3', 'bg-red-500', 'text-white', 'px-3', 'py-1', 'rounded', 'hover:bg-red-600');
                removeButton.textContent = 'Supprimer';
                removeButton.addEventListener('click', function () {
                    let checkbox = div.querySelector('input[type="checkbox"]'); // Sélectionner la case à cocher associée
                    checkbox.checked = true; // Cochez la case pour marquer l'image comme supprimée
                    let imageId = div.querySelector('input[name$="[id]"]').value; // Récupérer l'ID de l'image
                    let removeField = div.querySelector('input[name$="[remove]"]'); // Récupérer le champ remove
                    
                    // Si le champ remove n'existe pas déjà, le créer
                    if (!removeField) {
                        removeField = document.createElement('input');
                        removeField.type = 'hidden';
                        removeField.name = 'oeuvre[images][__name__][remove]';
                        removeField.value = '1'; // Set remove à 1 pour marquer l'image comme supprimée
                        div.appendChild(removeField);
                    }
        
                    // Supprimer l'image de l'affichage
                    div.remove();
                });
        
                div.appendChild(removeButton);
                collectionHolder.appendChild(div);
            });
        
            collectionHolder.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-image')) {
                    let checkbox = e.target.closest('.image-block').querySelector('input[type="checkbox"]');
                    checkbox.checked = true; // Cochez la case pour marquer l'image comme supprimée
                    let removeField = e.target.closest('.image-block').querySelector('input[name$="[remove]"]');
                    
                    // Créez un champ hidden si il n'existe pas déjà pour marquer l'image comme supprimée
                    if (!removeField) {
                        removeField = document.createElement('input');
                        removeField.type = 'hidden';
                        removeField.name = 'oeuvre[images][__name__][remove]';
                        removeField.value = '1';
                        e.target.closest('.image-block').appendChild(removeField);
                    }
        
                    e.target.closest('.image-block').remove(); // Supprimer l'image de l'affichage
                }
            });
        });          
    </script>
{% endblock %}
